<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Telegram Messenger</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Telegram Web App script -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- Marked.js for Markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- DOMPurify for sanitizing HTML output from Markdown -->
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
    <style>
        /* Basic theme variables from Telegram */
        :root {
            --tg-theme-bg-color: #ffffff;
            --tg-theme-text-color: #000000;
            --tg-theme-hint-color: #999999;
            --tg-theme-link-color: #2481cc;
            --tg-theme-button-color: #2481cc;
            --tg-theme-button-text-color: #ffffff;
            --tg-theme-secondary-bg-color: #f4f4f4;
        }
        /* Custom styles */
        body {
            background-color: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            transition: background-color 0.3s, color 0.3s;
            overscroll-behavior-y: none;
            -webkit-font-smoothing: antialiased;
        }
        #chat-messages .message-content a {
            color: var(--tg-theme-link-color);
        }
        #chat-messages .message-content pre {
            background-color: var(--tg-theme-secondary-bg-color);
            padding: 12px;
            border-radius: 8px;
            overflow-x: auto;
            font-size: 0.9em;
        }
        #chat-messages .message-content code {
            font-family: monospace;
        }
        #chat-messages .message-content pre code {
             background-color: transparent;
             padding: 0;
        }
        #message-input {
            background-color: var(--tg-theme-secondary-bg-color);
            color: var(--tg-theme-text-color);
            scrollbar-width: none; /* Firefox */
        }
        #message-input::-webkit-scrollbar {
            display: none; /* Safari and Chrome */
        }
        .btn-primary {
            background-color: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
        }
         .btn-secondary {
            background-color: var(--tg-theme-secondary-bg-color);
            color: var(--tg-theme-text-color);
        }
    </style>
</head>
<body class="overflow-hidden">

    <!-- Main App Container -->
    <div id="app-container" class="h-screen w-screen flex flex-col hidden">
        <!-- Chat Messages Area -->
        <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-4">
            <!-- Messages will be injected here -->
        </div>

        <!-- Typing Indicator -->
        <div id="typing-indicator" class="px-4 pb-2 text-sm hidden">
             <span class="text-gray-500 dark:text-gray-400">Бот печатает...</span>
        </div>

        <!-- Input Form Area -->
        <div id="input-area" class="p-2 border-t border-gray-200 dark:border-gray-700">
             <div class="flex items-end space-x-2">
                 <button id="clear-btn" class="p-3 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                 </button>

                 <textarea id="message-input" rows="1" placeholder="Введите сообщение..." class="flex-1 p-3 rounded-2xl resize-none border-none focus:ring-0"></textarea>
                 
                 <button id="send-btn" class="p-3 rounded-full btn-primary transition-colors flex-shrink-0">
                     <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M3.105 2.289a.75.75 0 00-.826.95l1.414 4.949a.75.75 0 00.95.826L11.25 9.25l-6.507-1.084a.75.75 0 00-.95.826l1.414 4.949a.75.75 0 00.95.826l6.507-1.084a.75.75 0 000-1.414L3.105 2.289z"></path></svg>
                 </button>
            </div>
             <div class="mt-2 flex justify-center items-center relative">
                 <button id="model-selector" class="text-xs px-3 py-1 rounded-lg btn-secondary transition-colors"></button>
                 <div id="model-list" class="absolute bottom-full mb-2 w-48 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg shadow-lg hidden">
                     <!-- Models will be populated here -->
                 </div>
            </div>
        </div>
    </div>

    <!-- Error container for non-Telegram access -->
    <div id="error-container" class="h-screen w-screen flex items-center justify-center p-4 text-center hidden">
        <div>
            <h1 class="text-2xl font-bold">Ошибка доступа</h1>
            <p class="mt-2 text-lg">Пожалуйста, откройте это приложение внутри Telegram.</p>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const tg = window.Telegram.WebApp;

            // --- ACCESS CHECK ---
            if (!tg.initData) {
                document.getElementById('app-container').classList.add('hidden');
                document.getElementById('error-container').classList.remove('hidden');
                // Apply theme to error message as well
                if (tg.colorScheme === 'dark') {
                   document.documentElement.classList.add('dark');
                }
                return;
            }
            
            // --- INITIALIZE APP ---
            tg.ready();
            tg.expand();
            document.getElementById('app-container').classList.remove('hidden');

            // --- DOM ELEMENTS ---
            const chatMessages = document.getElementById('chat-messages');
            const messageInput = document.getElementById('message-input');
            const sendBtn = document.getElementById('send-btn');
            const clearBtn = document.getElementById('clear-btn');
            const modelSelector = document.getElementById('model-selector');
            const modelList = document.getElementById('model-list');
            const typingIndicator = document.getElementById('typing-indicator');

            // --- STATE MANAGEMENT ---
            let messages = [];
            let isLoading = false;
            const models = [
                { name: 'ChatGPT 4.1', value: 'openai-large' },
                { name: 'ChatGPT 4.1 Nano', value: 'gpt-4.1-nano' },
                { name: 'ChatGPT 4o mini', value: 'openai' },
                { name: 'xAi Grok 3 Mini', value: 'grok-3-mini' },
                { name: 'Mistral 3.1', value: 'mistral' },
                { name: 'ChatGPT 4o mini', value: 'openai' }
            ];
            let currentModel = models[1]; // Default to ChatGPT 4o mini

            // --- FUNCTIONS ---

            // Apply Telegram theme
            const applyTheme = () => {
                const scheme = tg.colorScheme;
                document.documentElement.style.setProperty('--tg-theme-bg-color', tg.themeParams.bg_color || (scheme === 'dark' ? '#18222d' : '#ffffff'));
                document.documentElement.style.setProperty('--tg-theme-text-color', tg.themeParams.text_color || (scheme === 'dark' ? '#ffffff' : '#000000'));
                document.documentElement.style.setProperty('--tg-theme-hint-color', tg.themeParams.hint_color || (scheme === 'dark' ? '#708499' : '#999999'));
                document.documentElement.style.setProperty('--tg-theme-link-color', tg.themeParams.link_color || '#2481cc');
                document.documentElement.style.setProperty('--tg-theme-button-color', tg.themeParams.button_color || '#2481cc');
                document.documentElement.style.setProperty('--tg-theme-button-text-color', tg.themeParams.button_text_color || '#ffffff');
                document.documentElement.style.setProperty('--tg-theme-secondary-bg-color', tg.themeParams.secondary_bg_color || (scheme === 'dark' ? '#23303e' : '#f4f4f4'));

                if (scheme === 'dark') {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
            };
            
            // Update UI with the current model
            const updateModelSelection = () => {
                modelSelector.textContent = `Модель: ${currentModel.name}`;
            };

            // Populate the model list
            const populateModelList = () => {
                modelList.innerHTML = '';
                models.forEach(model => {
                    const item = document.createElement('div');
                    item.className = 'p-2 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer text-center';
                    item.textContent = model.name;
                    item.onclick = () => {
                        currentModel = model;
                        updateModelSelection();
                        modelList.classList.add('hidden');
                    };
                    modelList.appendChild(item);
                });
            };

            // Toggle model list visibility
            const toggleModelList = () => {
                modelList.classList.toggle('hidden');
            };

            // Scroll chat to the bottom
            const scrollToBottom = () => {
                chatMessages.scrollTop = chatMessages.scrollHeight;
            };

            // Render all messages
            const renderMessages = () => {
                chatMessages.innerHTML = '';
                messages.forEach(msg => addMessageToUI(msg.role, msg.content));
                scrollToBottom();
            };

            // Add a single message to the UI
            const addMessageToUI = (role, content) => {
                const messageWrapper = document.createElement('div');
                messageWrapper.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'}`;

                const messageBubble = document.createElement('div');
                messageBubble.className = `max-w-xs md:max-w-md lg:max-w-lg p-3 rounded-2xl message-content ${role === 'user' ? 'bg-blue-500 text-white' : 'bg-gray-200 dark:bg-gray-700 text-black dark:text-white'}`;
                
                const sanitizedHtml = DOMPurify.sanitize(marked.parse(content));
                messageBubble.innerHTML = sanitizedHtml;
                
                messageWrapper.appendChild(messageBubble);
                chatMessages.appendChild(messageWrapper);
            };
            
            // Adjust textarea height based on content
            const adjustTextareaHeight = () => {
                 messageInput.style.height = 'auto';
                 messageInput.style.height = (messageInput.scrollHeight) + 'px';
            };

            // Handle sending messages
            const handleSendMessage = async () => {
                if (isLoading) return;
                
                const userInput = messageInput.value.trim();
                if (!userInput) return;
                
                isLoading = true;
                sendBtn.disabled = true;
                typingIndicator.classList.remove('hidden');

                addMessageToUI('user', userInput);
                messages.push({ role: 'user', content: userInput });
                scrollToBottom();
                
                // Prepare request payload
                const history = messages.map(({role, content}) => ({role, content}));
                const payload = {
                    model: currentModel.value,
                    referrer: "swlk",
                    messages: [
                        { role: "system", content: "Используй Markdown форматирование, не используй MathJax" },
                        ...history.slice(-10) // Send last 10 messages as history
                    ],
                    stream: true,
                };

                // Clear input
                messageInput.value = '';
                adjustTextareaHeight();
                
                // Create a placeholder for the bot's response
                const botMessageWrapper = document.createElement('div');
                botMessageWrapper.className = 'flex justify-start';
                const botMessageBubble = document.createElement('div');
                botMessageBubble.className = 'max-w-xs md:max-w-md lg:max-w-lg p-3 rounded-2xl message-content bg-gray-200 dark:bg-gray-700 text-black dark:text-white';
                botMessageBubble.innerHTML = '<span class="animate-pulse">...</span>';
                botMessageWrapper.appendChild(botMessageBubble);
                chatMessages.appendChild(botMessageWrapper);
                scrollToBottom();

                let botResponseContent = '';

                try {
                    const response = await fetch('https://text.pollinations.ai/openai', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();

                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;
                        
                        const chunk = decoder.decode(value, { stream: true });
                        const lines = chunk.split('\n').filter(line => line.trim() !== '');

                        for (const line of lines) {
                            if (line.startsWith('data: ')) {
                                const jsonString = line.substring(6);
                                if (jsonString === '[DONE]') continue;
                                try {
                                    const data = JSON.parse(jsonString);
                                    const contentPart = data.choices?.[0]?.delta?.content || '';
                                    if (contentPart) {
                                        botResponseContent += contentPart;
                                        const sanitizedHtml = DOMPurify.sanitize(marked.parse(botResponseContent));
                                        botMessageBubble.innerHTML = sanitizedHtml;
                                        scrollToBottom();
                                    }
                                } catch (e) {
                                    console.error('Error parsing stream JSON:', jsonString);
                                }
                            }
                        }
                    }

                } catch (error) {
                    console.error('Fetch error:', error);
                    botMessageBubble.innerHTML = 'Произошла ошибка. Пожалуйста, попробуйте снова.';
                    botResponseContent = 'Произошла ошибка.';
                } finally {
                    messages.push({ role: 'assistant', content: botResponseContent });
                    localStorage.setItem('chatHistory', JSON.stringify(messages));
                    typingIndicator.classList.add('hidden');
                    isLoading = false;
                    sendBtn.disabled = false;
                }
            };
            
            // Handle clearing chat history
            const confirmClearHistory = () => {
                tg.showConfirm("Вы уверены, что хотите очистить историю?", (confirmed) => {
                    if (confirmed) {
                        messages = [];
                        localStorage.removeItem('chatHistory');
                        chatMessages.innerHTML = '';
                    }
                });
            };

            // --- EVENT LISTENERS ---
            tg.onEvent('themeChanged', applyTheme);
            sendBtn.addEventListener('click', handleSendMessage);
            messageInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    handleSendMessage();
                }
            });
            messageInput.addEventListener('input', adjustTextareaHeight);
            clearBtn.addEventListener('click', confirmClearHistory);
            modelSelector.addEventListener('click', toggleModelList);
            
            // Close model list if clicked outside
            document.addEventListener('click', (e) => {
                if (!modelSelector.contains(e.target) && !modelList.contains(e.target)) {
                    modelList.classList.add('hidden');
                }
            });

            // --- INITIALIZATION CALLS ---
            applyTheme();
            updateModelSelection();
            populateModelList();

            // Load history from localStorage
            const savedHistory = localStorage.getItem('chatHistory');
            if (savedHistory) {
                messages = JSON.parse(savedHistory);
                renderMessages();
            }

            // Handle ?text= parameter
            const urlParams = new URLSearchParams(window.location.search);
            const initialText = urlParams.get('text');
            if (initialText && messages.length === 0) {
                 messages.push({ role: 'assistant', content: initialText });
                 renderMessages();
            }
        });
    </script>
</body>
</html>