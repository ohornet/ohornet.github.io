<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Telegram Messenger</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Telegram Web App script -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- Marked.js for Markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- DOMPurify for sanitizing HTML output from Markdown -->
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
    <style>
        /* Basic theme variables from Telegram */
        :root {
            --tg-theme-bg-color: #ffffff;
            --tg-theme-text-color: #000000;
            --tg-theme-hint-color: #999999;
            --tg-theme-link-color: #2481cc;
            --tg-theme-button-color: #2481cc;
            --tg-theme-button-text-color: #ffffff;
            --tg-theme-secondary-bg-color: #f4f4f4;
        }
        /* Custom styles */
        body {
            background-color: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            transition: background-color 0.3s, color 0.3s;
            overscroll-behavior-y: none;
            -webkit-font-smoothing: antialiased;
        }
        #chat-messages .message-content a {
            color: var(--tg-theme-link-color);
        }
        #chat-messages .message-content pre {
            background-color: var(--tg-theme-secondary-bg-color);
            padding: 12px;
            border-radius: 8px;
            overflow-x: auto;
            font-size: 0.9em;
        }
        #chat-messages .message-content code {
            font-family: monospace;
        }
        #chat-messages .message-content pre code {
            background-color: transparent;
            padding: 0;
        }
        #message-input {
            background-color: var(--tg-theme-secondary-bg-color);
            color: var(--tg-theme-text-color);
            scrollbar-width: none; /* Firefox */
        }
        #message-input::-webkit-scrollbar {
            display: none; /* Safari and Chrome */
        }
        .btn-primary {
            background-color: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
        }
         .btn-secondary {
            background-color: var(--tg-theme-secondary-bg-color);
            color: var(--tg-theme-text-color);
        }
    </style>
</head>
<body class="overflow-hidden">

    <!-- Main App Container -->
    <div id="app-container" class="h-screen w-screen flex flex-col">
        <!-- Chat Messages Area -->
        <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-4">
            <!-- Messages will be injected here -->
        </div>

        <!-- Typing Indicator -->
        <div id="typing-indicator" class="px-4 pb-2 text-sm hidden">
             <span class="text-gray-500 dark:text-gray-400">Бот печатает...</span>
        </div>

        <!-- Input Form Area -->
        <div id="input-area" class="p-2 border-t border-gray-200 dark:border-gray-700">
             <div class="flex items-end space-x-2">
                <!-- Theme Toggle Button (for non-TG users) -->
                <button id="theme-toggle-btn" class="p-3 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors hidden flex-shrink-0">
                    <!-- Moon Icon -->
                    <svg id="theme-icon-dark" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                    <!-- Sun Icon -->
                    <svg id="theme-icon-light" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707.707M6.343 6.343l-.707-.707m12.728 0l-.707-.707M6.343 17.657l-.707.707M12 5a7 7 0 100 14 7 7 0 000-14z"></path></svg>
                </button>

                <button id="clear-btn" class="p-3 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors flex-shrink-0">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                </button>

                <textarea id="message-input" rows="1" placeholder="Введите сообщение..." class="flex-1 p-3 rounded-2xl resize-none border-none focus:ring-0"></textarea>
                
                <button id="send-btn" class="p-3 rounded-full btn-primary transition-colors flex-shrink-0">
                    <!-- Paper Plane Icon -->
                    <svg class="w-6 h-6 transform rotate-90" fill="currentColor" viewBox="0 0 24 24"><path d="M2 21l21-9L2 3v7l15 2-15 2v7z"></path></svg>
                </button>
             </div>
             <div class="mt-2 flex justify-center items-center relative">
                 <button id="model-selector" class="text-xs px-3 py-1 rounded-lg btn-secondary transition-colors"></button>
                 <div id="model-list" class="absolute bottom-full mb-2 w-48 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg shadow-lg hidden">
                     <!-- Models will be populated here -->
                 </div>
             </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const tg = window.Telegram.WebApp;

            // --- FEATURE DETECTION ---
            // Check if running inside Telegram by looking for initData
            const isTelegramUser = tg.initData && Object.keys(tg.initData).length > 0;

            // --- INITIALIZE APP ---
            if (isTelegramUser) {
                tg.ready();
                tg.expand();
            }

            // --- DOM ELEMENTS ---
            const chatMessages = document.getElementById('chat-messages');
            const messageInput = document.getElementById('message-input');
            const sendBtn = document.getElementById('send-btn');
            const clearBtn = document.getElementById('clear-btn');
            const modelSelector = document.getElementById('model-selector');
            const modelList = document.getElementById('model-list');
            const typingIndicator = document.getElementById('typing-indicator');
            const themeToggleBtn = document.getElementById('theme-toggle-btn');
            const themeIconDark = document.getElementById('theme-icon-dark');
            const themeIconLight = document.getElementById('theme-icon-light');

            // --- STATE MANAGEMENT ---
            let messages = [];
            let isLoading = false;
            const models = [
                { name: 'ChatGPT 4.1', value: 'openai-large' },
                { name: 'ChatGPT 4.1 Nano', value: 'gpt-4.1-nano' },
                { name: 'ChatGPT 4o mini', value: 'openai' },
                { name: 'xAi Grok 3 Mini', value: 'grok-3-mini' },
                { name: 'Mistral 3.1', value: 'mistral' },
            ];
            let currentModel = models[1]; // Default to ChatGPT 4.1 Nano

            // --- THEME MANAGEMENT ---
            const defaultThemes = {
                light: {
                    bg_color: '#ffffff', text_color: '#000000', hint_color: '#999999',
                    link_color: '#2481cc', button_color: '#2481cc', button_text_color: '#ffffff',
                    secondary_bg_color: '#f4f4f4',
                },
                dark: {
                    bg_color: '#18222d', text_color: '#ffffff', hint_color: '#708499',
                    link_color: '#2481cc', button_color: '#2481cc', button_text_color: '#ffffff',
                    secondary_bg_color: '#23303e',
                }
            };

            const applyTheme = (scheme) => {
                const themeParams = isTelegramUser ? tg.themeParams : defaultThemes[scheme];
                const finalScheme = isTelegramUser ? tg.colorScheme : scheme;

                document.documentElement.style.setProperty('--tg-theme-bg-color', themeParams.bg_color || defaultThemes[finalScheme].bg_color);
                document.documentElement.style.setProperty('--tg-theme-text-color', themeParams.text_color || defaultThemes[finalScheme].text_color);
                document.documentElement.style.setProperty('--tg-theme-hint-color', themeParams.hint_color || defaultThemes[finalScheme].hint_color);
                document.documentElement.style.setProperty('--tg-theme-link-color', themeParams.link_color || defaultThemes[finalScheme].link_color);
                document.documentElement.style.setProperty('--tg-theme-button-color', themeParams.button_color || defaultThemes[finalScheme].button_color);
                document.documentElement.style.setProperty('--tg-theme-button-text-color', themeParams.button_text_color || defaultThemes[finalScheme].button_text_color);
                document.documentElement.style.setProperty('--tg-theme-secondary-bg-color', themeParams.secondary_bg_color || defaultThemes[finalScheme].secondary_bg_color);

                if (finalScheme === 'dark') {
                    document.documentElement.classList.add('dark');
                    if (!isTelegramUser) {
                        themeIconDark.classList.add('hidden');
                        themeIconLight.classList.remove('hidden');
                    }
                } else {
                    document.documentElement.classList.remove('dark');
                    if (!isTelegramUser) {
                        themeIconDark.classList.remove('hidden');
                        themeIconLight.classList.add('hidden');
                    }
                }
            };

            // --- UI FUNCTIONS ---

            // Update UI with the current model
            const updateModelSelection = () => {
                modelSelector.textContent = `Модель: ${currentModel.name}`;
            };

            // Populate the model list
            const populateModelList = () => {
                modelList.innerHTML = '';
                models.forEach(model => {
                    const item = document.createElement('div');
                    item.className = 'p-2 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer text-center';
                    item.textContent = model.name;
                    item.onclick = () => {
                        currentModel = model;
                        updateModelSelection();
                        modelList.classList.add('hidden');
                    };
                    modelList.appendChild(item);
                });
            };

            // Toggle model list visibility
            const toggleModelList = () => {
                modelList.classList.toggle('hidden');
            };

            // Scroll chat to the bottom
            const scrollToBottom = () => {
                chatMessages.scrollTop = chatMessages.scrollHeight;
            };

            // Render all messages
            const renderMessages = () => {
                chatMessages.innerHTML = '';
                messages.forEach(msg => addMessageToUI(msg.role, msg.content));
                scrollToBottom();
            };

            // Add a single message to the UI
            const addMessageToUI = (role, content) => {
                const messageWrapper = document.createElement('div');
                messageWrapper.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'}`;

                const messageBubble = document.createElement('div');
                messageBubble.className = `max-w-xs md:max-w-md lg:max-w-lg p-3 rounded-2xl message-content ${role === 'user' ? 'btn-primary' : 'bg-gray-200 dark:bg-gray-700 text-black dark:text-white'}`;
                
                // Use a different color for user messages if the button color is too light
                if (role === 'user') {
                     messageBubble.style.backgroundColor = 'var(--tg-theme-button-color)';
                     messageBubble.style.color = 'var(--tg-theme-button-text-color)';
                }

                const sanitizedHtml = DOMPurify.sanitize(marked.parse(content));
                messageBubble.innerHTML = sanitizedHtml;
                
                messageWrapper.appendChild(messageBubble);
                chatMessages.appendChild(messageWrapper);
            };
            
            // Adjust textarea height based on content
            const adjustTextareaHeight = () => {
                 messageInput.style.height = 'auto';
                 // Limit max height to prevent it from taking over the screen
                 const maxHeight = window.innerHeight * 0.4;
                 messageInput.style.height = (Math.min(messageInput.scrollHeight, maxHeight)) + 'px';
            };

            // Handle sending messages
            const handleSendMessage = async () => {
                if (isLoading) return;
                
                const userInput = messageInput.value.trim();
                if (!userInput) return;
                
                isLoading = true;
                sendBtn.disabled = true;
                sendBtn.classList.add('opacity-50');
                typingIndicator.classList.remove('hidden');

                addMessageToUI('user', userInput);
                messages.push({ role: 'user', content: userInput });
                scrollToBottom();
                
                // Prepare request payload
                const history = messages.map(({role, content}) => ({role, content}));
                const payload = {
                    model: currentModel.value,
                    referrer: "swlk",
                    messages: [
                        { role: "system", content: "Используй Markdown форматирование, не используй MathJax" },
                        ...history.slice(-10) // Send last 10 messages as history
                    ],
                    stream: true,
                };

                // Clear input
                messageInput.value = '';
                adjustTextareaHeight();
                
                // Create a placeholder for the bot's response
                const botMessageWrapper = document.createElement('div');
                botMessageWrapper.className = 'flex justify-start';
                const botMessageBubble = document.createElement('div');
                botMessageBubble.className = 'max-w-xs md:max-w-md lg:max-w-lg p-3 rounded-2xl message-content bg-gray-200 dark:bg-gray-700 text-black dark:text-white';
                botMessageBubble.innerHTML = '<span class="animate-pulse">...</span>';
                botMessageWrapper.appendChild(botMessageBubble);
                chatMessages.appendChild(botMessageWrapper);
                scrollToBottom();

                let botResponseContent = '';

                try {
                    const response = await fetch('https://text.pollinations.ai/openai', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();

                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;
                        
                        const chunk = decoder.decode(value, { stream: true });
                        const lines = chunk.split('\n').filter(line => line.trim() !== '');

                        for (const line of lines) {
                            if (line.startsWith('data: ')) {
                                const jsonString = line.substring(6);
                                if (jsonString === '[DONE]') continue;
                                try {
                                    const data = JSON.parse(jsonString);
                                    const contentPart = data.choices?.[0]?.delta?.content || '';
                                    if (contentPart) {
                                        botResponseContent += contentPart;
                                        const sanitizedHtml = DOMPurify.sanitize(marked.parse(botResponseContent));
                                        botMessageBubble.innerHTML = sanitizedHtml;
                                        scrollToBottom();
                                    }
                                } catch (e) {
                                    console.error('Error parsing stream JSON:', jsonString);
                                }
                            }
                        }
                    }

                } catch (error) {
                    console.error('Fetch error:', error);
                    botMessageBubble.innerHTML = 'Произошла ошибка. Пожалуйста, попробуйте снова.';
                    botResponseContent = 'Произошла ошибка.';
                } finally {
                    messages.push({ role: 'assistant', content: botResponseContent });
                    localStorage.setItem('chatHistory', JSON.stringify(messages));
                    typingIndicator.classList.add('hidden');
                    isLoading = false;
                    sendBtn.disabled = false;
                    sendBtn.classList.remove('opacity-50');
                }
            };
            
            // Handle clearing chat history
            const confirmClearHistory = () => {
                const clearAction = () => {
                    messages = [];
                    localStorage.removeItem('chatHistory');
                    chatMessages.innerHTML = '';
                };

                if (isTelegramUser) {
                    tg.showConfirm("Вы уверены, что хотите очистить историю?", (confirmed) => {
                        if (confirmed) {
                            clearAction();
                        }
                    });
                } else {
                    // Use standard browser confirm for non-telegram users
                    if (window.confirm("Вы уверены, что хотите очистить историю?")) {
                        clearAction();
                    }
                }
            };

            // --- EVENT LISTENERS ---
            if (isTelegramUser) {
                tg.onEvent('themeChanged', () => applyTheme(tg.colorScheme));
            } else {
                // Setup for non-telegram users
                themeToggleBtn.classList.remove('hidden');
                let currentLocalTheme = localStorage.getItem('chatTheme') || 'light';
                
                themeToggleBtn.addEventListener('click', () => {
                    currentLocalTheme = currentLocalTheme === 'light' ? 'dark' : 'light';
                    localStorage.setItem('chatTheme', currentLocalTheme);
                    applyTheme(currentLocalTheme);
                });
            }

            sendBtn.addEventListener('click', handleSendMessage);
            messageInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    handleSendMessage();
                }
            });
            messageInput.addEventListener('input', adjustTextareaHeight);
            clearBtn.addEventListener('click', confirmClearHistory);
            modelSelector.addEventListener('click', toggleModelList);
            
            // Close model list if clicked outside
            document.addEventListener('click', (e) => {
                if (!modelSelector.contains(e.target) && !modelList.contains(e.target)) {
                    modelList.classList.add('hidden');
                }
            });

            // --- INITIALIZATION CALLS ---
            const initialTheme = isTelegramUser ? tg.colorScheme : (localStorage.getItem('chatTheme') || 'light');
            applyTheme(initialTheme);
            updateModelSelection();
            populateModelList();
            adjustTextareaHeight();

            // Load history from localStorage
            const savedHistory = localStorage.getItem('chatHistory');
            if (savedHistory) {
                messages = JSON.parse(savedHistory);
                renderMessages();
            }

            // Handle ?text= parameter
            const urlParams = new URLSearchParams(window.location.search);
            const initialText = urlParams.get('text');
            if (initialText && messages.length === 0) {
                 messages.push({ role: 'assistant', content: initialText });
                 renderMessages();
            }
        });
    </script>
</body>
</html>